<!doctype html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clock Settings</title>
    <link rel="stylesheet" href="assets/css/foundation.css">
</head>
<body>
    <div class="grid-container">
        <div class="grid-x grid-padding-x">
            <div class="large-12 text-center cell">
                <div class="grid-x grid-padding-y">
                    <div class="large-12 cell">
                        <h3>Clock Settings</h3>
                    </div>
                </div>

                <div class="grid-x grid-padding-x">
                    <div class="large-12 cell">

                        <div class="grid-x grid-padding-x">
                            <div class="large-8 medium-8 center cell">
                                <div class="callout">
                                    <div class="grid-x grid-margin-x align-middle">
                                        <div class="large-6 medium-6 cell">
                                            <div class="grid-x grid-padding-x">
                                                <div class="large-12 medium-12 small-12 cell">
                                                    WiFi Settings
                                                    <div class="grid-x grid-margin-x">
                                                        <div class="large-12 medium-12 small-12 cell">
                                                            <input type="text" id="wifiSSID" placeholder="WiFi SSID">
                                                        </div>
                                                        <div class="large-12 medium-12 small-12 cell">
                                                            <input type="password" id="wifiPassword" placeholder="WiFi Password">
                                                        </div>
                                                        <div class="large-12 medium-12 small-12 cell">
                                                            <button class="submit success button" onclick="setWiFi()">Set WiFi Credentials</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="large-6 medium-6 cell">
                                            Access Point Settings
                                            <div class="grid-x grid-margin-x">
                                                <div class="large-12 medium-12 small-12 cell">
                                                    <input type="text" id="apSSID" placeholder="AP SSID">
                                                </div>
                                                <div class="large-12 medium-12 small-12 cell">
                                                    <input type="password" id="apPassword" placeholder="AP Password">
                                                </div>
                                                <div class="large-12 medium-12 small-12 cell">
                                                    <button class="submit success button" onclick="setAP()">Set AP Credentials</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid-x grid-padding-y">
                                        <div class="large-12 medium-12 small-12 cell">
                                            <div class="callout">
                                                <div class="grid-x grid-margin-x">
                                                    <div class="large-12 medium-12 small-12 cell">
                                                        <h4>Device Status</h4>
                                                        <p>WiFi Name: <span id="wifiName"></span></p>
                                                        <p>IP Address: <span id="ipAddress"></span></p>
                                                        <p>NTP Server Status: <span id="ntpStatus"></span></p>
                                                        <p>Current Time: <span id="currentTime"></span></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid-x grid-padding-x">
                            <div class="large-8 medium-8 center cell">
                                <div class="callout">
                                    <div class="grid-x grid-margin-x align-middle">
                                        <div class="large-6 medium-6 small-6 cell">
                                            <div class="grid-x grid-margin-x">
                                                <div class="large-12 medium-12 small-12 cell">
                                                    Manual
                                                    <div class="grid-x grid-margin-x">
                                                        <div class="large-12 medium-12 small-12 cell">
                                                            <button class="submit success button" onclick="syncTime()">Sync Time</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="large-6 medium-6 small-6 cell">
                                            <div class="grid-x grid-margin-x">
                                                <div class="large-12 medium-12 small-12 cell">
                                                    NTP
                                                    <div class="grid-x grid-margin-x">
                                                        <div class="large-12 medium-12 small-12 cell">
                                                            <input type="text" id="ntpServer" placeholder="NTP Server">
                                                        </div>
                                                        <div class="large-12 medium-12 small-12 cell">
                                                            <button class="submit success button" onclick="setNTPServer()">Set NTP Server</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="grid-x grid-margin-x center">
                                            <div class="large-12 medium-12 small-12 cell">
                                                <div class="large-6 medium-6 small-6 cell">
                                                    <div class="grid-x grid-margin-x">
                                                        <div class="large-12 medium-12 small-12 cell">
                                                            <h4>Jadwal Shalat</h4>
                                                            <div class="grid-x grid-margin-x">
                                                                <div class="large-12 medium-12 small-12 cell">
                                                                    <label>Pilih Kota
                                                                        <select id="citySelect">
                                                                            <option value="">Pilih Kota</option>
                                                                        </select>
                                                                    </label>
                                                                </div>
                                                                <div class="large-12 medium-12 small-12 cell">
                                                                    <button class="button" onclick="updatePrayerTimes()">Update Jadwal Shalat</button>
                                                                </div>
                                                            </div>
                                                            <div id="prayerTimes"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid-x grid-padding-x">
                            <div class="large-8 medium-8 small-12 center cell">
                                <div class="grid-x grid-margin-x">
                                    <div class="large-12 medium-12 small-12 cell">
                                        <div class="callout alert">
                                            <h4>Reset All Settings</h4>
                                            <p>This will reset all settings (WiFi, NTP, and AP) to their default values. The device will restart after resetting.</p>
                                            <button class="alert button" onclick="resetSettings()">Reset All Settings</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetchCities();
            loadSavedPrayerTimes();
            loadSavedCity();
            updateDeviceStatus();
            setInterval(updateDeviceStatus, 5000);
        });

        function updateDeviceStatus() {
            fetch('/devicestatus')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('wifiStatus').textContent = data.ssid || 'Tidak Terhubung';
                    document.getElementById('ipAddress').textContent = data.ip || '-';
                    document.getElementById('currentTime').textContent = data.currentTime || '-';
                })
                .catch(error => console.error('Error:', error));
        }

        function fetchCities() {
            fetch('/getcities')
                .then(response => response.json())
                .then(data => {
                    const citySelect = document.getElementById('citySelect');
                    citySelect.innerHTML = ''; // Clear existing options

                    if (data.status === "offline") {
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "Aktifkan Internet";
                        citySelect.appendChild(option);
                        citySelect.disabled = true;
                    } else {
                        const defaultOption = document.createElement('option');
                        defaultOption.value = "";
                        defaultOption.textContent = "Pilih Kota";
                        citySelect.appendChild(defaultOption);

                        data.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city.id;
                            option.textContent = city.lokasi;
                            citySelect.appendChild(option);
                        });
                        citySelect.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const citySelect = document.getElementById('citySelect');
                    citySelect.innerHTML = '<option value="">Aktifkan Internet</option>';
                    citySelect.disabled = true;
                });
        }

        function loadSavedPrayerTimes() {
            fetch('/getprayertimes')
                .then(response => response.json())
                .then(data => {
                    updatePrayerTimesDisplay(data);
                })
                .catch(error => console.error('Error:', error));
        }

        function loadSavedCity() {
            fetch('/getselectedcity')
                .then(response => response.text())
                .then(cityId => {
                    if (cityId) {
                        document.getElementById('citySelect').value = cityId;
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function updatePrayerTimesDisplay(data) {
            const prayerTimesDiv = document.getElementById('prayerTimes');
            prayerTimesDiv.innerHTML = `
                <p>Subuh: ${data.subuh}</p>
                <p>Zuhur: ${data.dzuhur}</p>
                <p>Asar: ${data.ashar}</p>
                <p>Maghrib: ${data.maghrib}</p>
                <p>Isya: ${data.isya}</p>
            `;
        }

        function updatePrayerTimes() {
            const citySelect = document.getElementById('citySelect');
            if (citySelect.disabled) {
                alert('Tidak ada koneksi internet. Silakan aktifkan internet dan coba lagi.');
                return;
            }

            const cityId = citySelect.value;
            if (!cityId) {
                alert('Silakan pilih kota terlebih dahulu');
                return;
            }

            fetch(`/updateprayertimes?cityId=${cityId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    updatePrayerTimesDisplay(data);
                    alert('Jadwal shalat berhasil diperbarui dan disimpan');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Gagal memperbarui jadwal shalat. Pastikan koneksi internet aktif.');
                });
        }

        function setWiFi() {
            const ssid = document.getElementById('wifiSSID').value;
            const password = document.getElementById('wifiPassword').value;

            if (!ssid) {
                alert('Silakan masukkan SSID WiFi');
                return;
            }

            fetch('/setwifi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `ssid=${encodeURIComponent(ssid)}&password=${encodeURIComponent(password)}`
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
                location.reload();
            })
            .catch(error => console.error('Error:', error));
        }

        function setAP() {
            const ssid = document.getElementById('apSSID').value;
            const password = document.getElementById('apPassword').value;

            if (!ssid) {
                alert('Silakan masukkan SSID Access Point');
                return;
            }

            fetch('/setap', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `ssid=${encodeURIComponent(ssid)}&password=${encodeURIComponent(password)}`
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
                location.reload();
            })
            .catch(error => console.error('Error:', error));
        }

        function setNTPServer() {
            const server = document.getElementById('ntpServer').value;

            if (!server) {
                alert('Silakan masukkan alamat server NTP');
                return;
            }

            fetch('/setntpserver', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `server=${encodeURIComponent(server)}`
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
            })
            .catch(error => console.error('Error:', error));
        }

        function syncTime() {
            fetch('/synctime', { method: 'POST' })
            .then(response => response.text())
            .then(data => {
                alert(data);
                updateDeviceStatus();
            })
            .catch(error => console.error('Error:', error));
        }

        function resetSettings() {
            if (confirm('Apakah Anda yakin ingin mereset semua pengaturan? Ini akan mengembalikan semua nilai ke default.')) {
                fetch('/reset', { method: 'POST' })
                .then(response => response.text())
                .then(data => {
                    alert(data);
                    location.reload();
                })
                .catch(error => console.error('Error:', error));
            }
        }

        // Event listener untuk perubahan pilihan kota
        document.getElementById('citySelect').addEventListener('change', function() {
            if (this.value) {
                updatePrayerTimes();
            }
        });
    </script>

</body>
</html>